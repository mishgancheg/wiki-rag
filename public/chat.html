<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wiki-RAG Chat</title>
  <style>
    :root{--bg:#f5f7fb;--panel:#ffffff;--text:#1f2937;--muted:#6b7280;--primary:#3b82f6;--primary-dark:#2563eb;--border:#e5e7eb;--assistant:#eef2ff;--user:#dcfce7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Fira Sans','Droid Sans','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text);}
    .chat-wrapper{display:flex;flex-direction:column;height:100vh;max-width:900px;margin:0 auto}
    .chat-header{height:56px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .chat-title{display:flex;align-items:center;gap:10px;font-weight:600}
    .chat-actions{display:flex;gap:8px}
    .btn{border:none;border-radius:10px;padding:8px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-weight:600}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-dark)}
    .btn-secondary{background:#ffffff22;color:#fff;border:1px solid #ffffff55}
    .chat-main{flex:1;display:flex;flex-direction:column;gap:8px;padding:12px;overflow:hidden}
    .messages{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;overflow:auto;display:flex;flex-direction:column}
    .msg{max-width:80%;padding:10px 12px;margin:6px 0;border-radius:14px;line-height:1.35;white-space:pre-wrap}
    .msg.user{align-self:flex-end;background:var(--user)}
    .msg.assistant{align-self:flex-start;background:var(--assistant)}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .composer{display:flex;gap:8px;align-items:flex-end}
    .input{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:10px}
    textarea{width:100%;border:none;outline:none;resize:none;min-height:44px;max-height:160px;font-size:15px;background:transparent}
    .send-btn{height:44px}
    .loader{display:inline-flex;gap:4px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#9aa4b2;animation:bounce 1s infinite}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-6px);opacity:1}}
    .sources{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">
      <div class="chat-title">üí¨ Wiki-RAG Chat <span style="opacity:.8;font-weight:400;font-size:13px">(–∫–∞–∫ –≤ –¢–µ–ª–µ–≥—Ä–∞–º)</span></div>
      <div class="chat-actions">
        <button id="clearBtn" class="btn btn-secondary" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        <a href="/" class="btn btn-secondary" title="–ù–∞ –≥–ª–∞–≤–Ω—É—é">üè†</a>
      </div>
    </div>
    <div class="chat-main">
      <div id="messages" class="messages"></div>
      <div class="composer">
        <div class="input"><textarea id="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –ø–µ—Ä–µ–Ω–æ—Å)"></textarea></div>
        <button id="sendBtn" class="btn btn-primary send-btn">‚û§</button>
      </div>
    </div>
  </div>

  <script type="module">
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');

    /**
     * Chat history in OpenAI-like shape: { role, content }
     */
    let history = [];

    function render() {
      messagesEl.innerHTML = '';
      for (const m of history) {
        const div = document.createElement('div');
        div.className = `msg ${m.role}`;
        div.textContent = m.content;
        messagesEl.appendChild(div);
        if (m.sources && m.sources.length) {
          const meta = document.createElement('div');
          meta.className = 'sources';
          meta.textContent = '–∏—Å—Ç–æ—á–Ω–∏–∫–∏: ' + m.sources.map(s => `${s.wiki_id} (${(s.similarity*100).toFixed(0)}%)`).join(', ');
          messagesEl.appendChild(meta);
        }
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addLoader() {
      const wrap = document.createElement('div');
      wrap.className = 'msg assistant';
      wrap.style.display = 'inline-flex';
      wrap.style.alignItems = 'center';
      const loader = document.createElement('div');
      loader.className = 'loader';
      loader.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      wrap.appendChild(loader);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return wrap;
    }

    async function sendMessage() {
      const text = (inputEl.value || '').trim();
      if (!text) return;
      inputEl.value = '';

      history.push({ role: 'user', content: text });
      render();

      const loaderEl = addLoader();

      const payload = {
        messages: history.slice(-10), // client-side cap
        threshold: 0.65,
        chunksLimit: 6,
      };

      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error('Network error');
        const data = await resp.json();

        loaderEl.remove();

        const assistantMsg = { role: 'assistant', content: data.reply || '' };
        if (Array.isArray(data.sources)) assistantMsg.sources = data.sources;
        history.push(assistantMsg);
        render();
      } catch (e) {
        loaderEl.remove();
        history.push({ role: 'assistant', content: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.' });
        render();
      }
    }

    // Events
    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    clearBtn.addEventListener('click', () => {
      history = [];
      render();
      inputEl.focus();
    });

    // Welcome message
    history.push({ role: 'assistant', content: '–ü—Ä–∏–≤–µ—Ç! –Ø —á–∞—Ç Wiki-RAG. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–∏—â—É –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.' });
    render();
    inputEl.focus();
  </script>
</body>
</html>
